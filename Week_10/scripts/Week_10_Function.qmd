---
title: "Week 10"
author: "Sk Abidur Rahman"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
format:
  html:
    toc: true
    theme: flatly
execute:
  warning: false
  message: false
---

## Overview
Define two general-purpose functions and demonstrate them on **built-in datasets** (`mtcars`, `iris`):

- `group_summary()`: **non-plot**: summary stats by one or two groups (n, mean, sd)  
- `smart_scatter()`: **plot**: clean scatter with trend (`lm`, `loess`, or `none`), color/facet



```{r}
#| label: setup
# install.packages(c("tidyverse","here")) 
library(tidyverse)
library(here)

# folders
dir.create(here("Week_10","output"), recursive = TRUE, showWarnings = FALSE)
```

##Function-1: Non-plot: group_summary()
```{r}
#| label: fn-group-summary #per-group summaries (n, mean, sd) for any numeric column, grouped by 1 or 2 factors.
group_summary <- function(data, value, group1, group2 = NULL) {
value  <- enquo(value)
group1 <- enquo(group1)
group2 <- enquo(group2)

if (rlang::quo_is_null(group2)) {
data %>%
group_by(!!group1) %>%
summarise(
n    = dplyr::n(),
mean = mean(!!value, na.rm = TRUE),
sd   = sd(!!value, na.rm = TRUE),
.groups = "drop"
)
} else {
data %>%
group_by(!!group1, !!group2) %>%
summarise(
n    = dplyr::n(),
mean = mean(!!value, na.rm = TRUE),
sd   = sd(!!value, na.rm = TRUE),
.groups = "drop"
)
}
}
```

## Non-plot

```{r}
iris_sum <- group_summary(iris, value = Sepal.Length, group1 = Species) ##Sepal.Length by Species
iris_sum
```


```{r}
mtcars_sum <- group_summary(mtcars, value = mpg, group1 = cyl, group2 = am)
mtcars_sum #MPG by cyl and am
write_csv(mtcars_sum, here("Week_10","output","mtcars_mpg_by_cyl_am.csv"))

```

#Function2: Plot

```{r}
#| label: fn-smart-scatter #polished scatter with trendline, color, and facet
smart_scatter <- function(data, x, y,
                          color = NULL,
                          facet = NULL,
                          trend = c("lm","loess","none"),
                          point_alpha = 0.7,
                          point_size = 2) {
  x <- rlang::enquo(x)
  y <- rlang::enquo(y)
  color <- rlang::enquo(color)
  facet <- rlang::enquo(facet)
  trend <- match.arg(trend)

  p <- ggplot(data, aes(x = !!x, y = !!y)) +
    geom_point(aes(color = !!color), alpha = point_alpha, size = point_size) +
    labs(
      x = rlang::as_name(x),
      y = rlang::as_name(y),
      color = if (!rlang::quo_is_null(color)) rlang::as_name(color) else NULL
    ) +
    theme_minimal(base_size = 12) +
    theme(panel.grid.minor = element_blank())

  if (trend != "none") {
    method <- if (trend == "lm") "lm" else "loess"
    p <- p + geom_smooth(method = method, se = TRUE)
  }

  if (!rlang::quo_is_null(facet)) {
    p <- p + facet_wrap(vars(!!facet), scales = "free")
  }

  return(p)
}

```

#Plot
```{r}
p1 <- smart_scatter(mtcars, x = wt, y = mpg, color = cyl, trend = "lm")
p1
ggsave(here("Week_10","output","mtcars_mpg_vs_wt_by_cyl.png"),
       p1, width = 8, height = 5, dpi = 320)
```


```{r}
#Sepal.Length vs Petal.Length, color + facet by Species, with loess trend
p2 <- smart_scatter(iris, x = Petal.Length, y = Sepal.Length, 
                    color = Species, facet = Species, 
                    trend = "loess", point_alpha = 0.6, point_size = 1.6) 
p2
 
ggsave(here("Week_10","output","iris_sepal_vs_petal_faceted.png"), p2, width = 10, height = 6, dpi = 320)